<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deki TTS</title>
    <link rel="icon" href="shortcut.png"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .spinner {
            border-top-color: #4f46e5; /* indigo-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the audio player in dark mode */
        audio::-webkit-media-controls-panel {
            background-color: #374151; /* gray-700 */
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-volume-slider,
        audio::-webkit-media-controls-fullscreen-button {
            filter: invert(1);
        }
        kbd {
            background-color: #374151;
            border-radius: 3px;
            border: 1px solid #4b5563;
            padding: 2px 4px;
            font-size: 0.8em;
            margin-left: 8px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 p-6 md:p-8 space-y-6">
        
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Anki Audio Generator</h1>
            <p class="text-gray-400 mt-2">Generate TTS for your flashcard sentences using ElevenLabs v3.</p>
        </div>

        <!-- Configuration Section -->
        <div class="p-6 bg-gray-900/50 rounded-xl border border-gray-700">
             <div class="text-center">
                <label for="fileInput" class="block text-sm font-medium text-gray-400 mb-2">1. Select your Anki Export File (.txt)</label>
                <input type="file" id="fileInput" accept=".txt" class="w-full max-w-sm mx-auto text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-indigo-500/10 file:text-indigo-400 hover:file:bg-indigo-500/20 file:border-gray-600">
            </div>
            <div class="text-center mt-4">
                 <label class="block text-sm font-medium text-gray-400 mb-2">2. Start the Process</label>
                <button id="loadFileBtn" class="w-full max-w-sm mx-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                    Load File & Start
                </button>
            </div>
        </div>

        <!-- Main Workspace -->
        <div id="workspace" class="hidden space-y-6">
            <!-- Progress & Status -->
            <div class="space-y-2">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-gray-400">Progress</span>
                    <span id="progressCounter" class="text-sm font-medium text-gray-400">0 / 0</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div id="statusLog" class="text-center text-sm text-gray-400 h-5"></div>
            </div>

            <!-- Current Item -->
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 text-center space-y-4">
                <div>
                    <p class="text-sm text-gray-400">Current Word</p>
                    <h2 id="currentWord" class="text-2xl font-bold text-indigo-400">-</h2>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Sentence to Generate</p>
                    <p id="currentText" class="text-lg font-medium text-gray-100">-</p>
                </div>
                <audio id="audioPlayer" controls class="w-full mt-4 hidden"></audio>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button id="generateBtn" class="bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">Generate<kbd>G</kbd></button>
                <button id="regenerateBtn" class="bg-yellow-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-transform transform hover:scale-105 btn-disabled" disabled>Regenerate<kbd>R</kbd></button>
                <button id="approveBtn" class="bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 btn-disabled" disabled>Approve<kbd>A</kbd></button>
                <button id="skipBtn" class="bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105">Skip<kbd>S</kbd></button>
            </div>
            
            <!-- Download Section -->
            <div class="text-center pt-4">
                 <button id="downloadZipBtn" class="w-full md:w-1/2 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105 btn-disabled" disabled>
                    Download All Approved as ZIP (<span id="zipCount">0</span> files)
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- Hardcoded User Settings ---
        const API_KEY = "sk_755fc47b8914502920f5e26246d5928c2e14432fb029ed89";
        const VOICE_ID = "FOfJ2PMgU6HOGbNYnzto";

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const loadFileBtn = document.getElementById('loadFileBtn');
        const workspace = document.getElementById('workspace');
        const progressCounter = document.getElementById('progressCounter');
        const progressBar = document.getElementById('progressBar');
        const statusLog = document.getElementById('statusLog');
        const currentWordEl = document.getElementById('currentWord');
        const currentTextEl = document.getElementById('currentText');
        const audioPlayer = document.getElementById('audioPlayer');
        const generateBtn = document.getElementById('generateBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const approveBtn = document.getElementById('approveBtn');
        const skipBtn = document.getElementById('skipBtn');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const zipCount = document.getElementById('zipCount');

        // App State
        let allRows = [];
        let currentRowIndex = 0;
        let currentSentenceIndex = 0;
        let lastGeneratedBlob = null;
        const approvedAudioBlobs = new Map();

        // --- Event Listeners ---
        loadFileBtn.addEventListener('click', handleFileLoad);
        generateBtn.addEventListener('click', () => processGeneration(false));
        regenerateBtn.addEventListener('click', () => processGeneration(true));
        approveBtn.addEventListener('click', handleApprove);
        skipBtn.addEventListener('click', handleSkip);
        downloadZipBtn.addEventListener('click', downloadZip);
        document.addEventListener('keydown', handleKeyPress);

        // --- Core Functions ---

        function handleKeyPress(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
            switch (event.key.toLowerCase()) {
                case 'g': if (!generateBtn.disabled) generateBtn.click(); break;
                case 'r': if (!regenerateBtn.disabled) regenerateBtn.click(); break;
                case 'a': if (!approveBtn.disabled) approveBtn.click(); break;
                case 's': if (!skipBtn.disabled) skipBtn.click(); break;
            }
        }

        function handleFileLoad() {
            const file = fileInput.files[0];
            if (!file) {
                updateStatus('Please select a file to load.', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                parseFileContent(content);
                if (allRows.length > 0) {
                    workspace.classList.remove('hidden');
                    updateUIForCurrentItem();
                    updateStatus('File loaded. Ready to generate.', 'success');
                } else {
                    updateStatus('File is empty or could not be parsed.', 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseFileContent(content) {
            allRows = [];
            const lines = content.split('\n');
            lines.forEach(line => {
                const columns = line.split('\t');
                if (columns.length >= 4) {
                    const germanWord = columns[1].trim();
                    const sentencesRaw = columns[3].trim();
                    if (germanWord && sentencesRaw) { // Ensure there is a word and at least one sentence
                        const sentences = sentencesRaw.split('<br>').map(s => s.trim()).filter(Boolean);
                        if (sentences.length > 0) {
                           allRows.push({ word: germanWord, sentences });
                        }
                    }
                }
            });
        }

        function updateUIForCurrentItem() {
            if (currentRowIndex >= allRows.length) {
                currentWordEl.textContent = "All Done!";
                currentTextEl.textContent = "You've processed all words.";
                disableAllActionButtons();
                updateStatus('Congratulations! You finished the list.', 'success');
                return;
            }

            const currentItem = allRows[currentRowIndex];
            let wordDisplay = currentItem.word;
            if (currentItem.sentences.length > 1) {
                wordDisplay += ` (${currentSentenceIndex + 1}/${currentItem.sentences.length})`;
            }
            currentWordEl.textContent = wordDisplay;
            currentTextEl.textContent = currentItem.sentences[currentSentenceIndex];
            
            audioPlayer.classList.add('hidden');
            audioPlayer.src = '';
            lastGeneratedBlob = null;

            updateButtons(false);
            updateProgress();
        }

        async function processGeneration(isRegen) {
            const textToGenerate = allRows[currentRowIndex].sentences[currentSentenceIndex];
            if (!textToGenerate) return;

            const payload = {
                "text": textToGenerate,
                "model_id": "eleven_v3",
                "voice_settings": { 
                    "stability": 1.0,
                    "similarity_boost": 0.88,
                    "style": 0.0,
                    "use_speaker_boost": true
                }
            };
            
            updateStatus(isRegen ? 'Regenerating audio...' : 'Generating audio...', 'loading');
            setLoadingState(true);

            const TTS_URL = `https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`;
            const headers = {
                "Accept": "audio/mpeg",
                "Content-Type": "application/json",
                "xi-api-key": API_KEY
            };

            try {
                const response = await fetch(TTS_URL, { method: 'POST', headers, body: JSON.stringify(payload) });
                if (response.ok) {
                    const blob = await response.blob();
                    lastGeneratedBlob = blob;
                    const audioUrl = URL.createObjectURL(blob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    audioPlayer.play();
                    updateStatus('Audio generated. Please review.', 'success');
                    updateButtons(true);
                } else {
                    const errorData = await response.json();
                    const errorMessage = errorData.detail ? errorData.detail.message : 'An unknown API error occurred.';
                    updateStatus(`Error: ${errorMessage}`, 'error');
                    updateButtons(false);
                }
            } catch (error) {
                updateStatus(`Network Error: ${error.message}`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        function handleApprove() {
            const currentItem = allRows[currentRowIndex];
            const numSentences = currentItem.sentences.length;
            
            let numSuffix = '';
            if (numSentences > 1 && currentSentenceIndex > 0) {
                numSuffix = (currentSentenceIndex + 1).toString();
            }
            const filename = `s_${currentItem.word}${numSuffix}.mp3`;

            if (lastGeneratedBlob) {
                approvedAudioBlobs.set(filename, lastGeneratedBlob);
                updateStatus(`Approved and saved: ${filename}`, 'success');
                zipCount.textContent = approvedAudioBlobs.size;
                downloadZipBtn.disabled = false;
                downloadZipBtn.classList.remove('btn-disabled');
            }

            // Move to the next sentence or word
            moveToNextItem();
        }

        function handleSkip() {
            updateStatus(`Skipped sentence`, 'info');
            moveToNextItem();
        }

        function moveToNextItem() {
            const currentItem = allRows[currentRowIndex];
            currentSentenceIndex++;
            if (currentSentenceIndex >= currentItem.sentences.length) {
                currentRowIndex++;
                currentSentenceIndex = 0;
            }
            updateUIForCurrentItem();
        }
        
        async function downloadZip() {
            if (approvedAudioBlobs.size === 0) {
                updateStatus('No approved audio files to download.', 'error');
                return;
            }
            updateStatus('Creating ZIP file... please wait.', 'loading');
            const zip = new JSZip();
            approvedAudioBlobs.forEach((blob, filename) => {
                zip.file(filename, blob);
            });
            try {
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "anki_audio_files.zip");
                updateStatus('ZIP file downloaded successfully!', 'success');
            } catch (error) {
                updateStatus(`Error creating ZIP: ${error.message}`, 'error');
            }
        }

        // --- UI Helper Functions ---
        function updateStatus(message, type = 'info') {
            statusLog.textContent = message;
            statusLog.classList.remove('text-red-500', 'text-green-500', 'text-blue-500', 'text-yellow-400');
            if (type === 'error') statusLog.classList.add('text-red-500');
            if (type === 'success') statusLog.classList.add('text-green-500');
            if (type === 'loading') statusLog.classList.add('text-blue-500');
            if (type === 'info') statusLog.classList.add('text-yellow-400');
        }

        function updateButtons(isGenerated) {
            generateBtn.disabled = isGenerated;
            generateBtn.classList.toggle('btn-disabled', isGenerated);
            regenerateBtn.disabled = !isGenerated;
            regenerateBtn.classList.toggle('btn-disabled', !isGenerated);
            approveBtn.disabled = !isGenerated;
            approveBtn.classList.toggle('btn-disabled', !isGenerated);
        }
        
        function disableAllActionButtons() {
            [generateBtn, regenerateBtn, approveBtn, skipBtn].forEach(btn => {
                btn.disabled = true;
                btn.classList.add('btn-disabled');
            });
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                generateBtn.innerHTML = `<div class="spinner w-5 h-5 mx-auto border-2 border-gray-400 rounded-full"></div>`;
                generateBtn.disabled = true;
                generateBtn.classList.add('btn-disabled');
            } else {
                generateBtn.innerHTML = 'Generate<kbd>G</kbd>';
            }
        }

        function updateProgress() {
            const total = allRows.length;
            const current = currentRowIndex;
            progressCounter.textContent = `${current} / ${total}`;
            const percentage = total > 0 ? (current / total) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
        }
    </script>
</body>
</html>